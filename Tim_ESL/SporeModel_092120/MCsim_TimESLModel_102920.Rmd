---
title: "MCsim_TimESLModel"
author: "Tim Lott, Sarah I. Murphy"
date: "9/21/2020"
output: pdf_document
---
Original file was spore model file copied from FISE folder on 9/21/2020. It was a simplified version (deleted unnecessary stuff) of MCsim.Rmd found in MC-2020 on GitHub, for use for the FISE project. The authors listed above are current contributors to this file. Additional authors of MCsim.Rmd include Samantha Lau, Timothy Lott, and Aljosa Trmcic. Earlier versions were the work of Ariel Buehler and Michael Phillips. Review README.md [https://github.com/FSL-MQIP/MC-2020/blob/master/README.md] for more information.

Revised 10/27/2020, Sarah Murphy & Tim Lott, wrote notes about how to model bacteria concentrations in units of fluid milk from the point of facility through end of storage at school; also made notes about modeling from point of facility through end of storage at home, but will implement modeling school milk first. For initial modeling, implementation will be similar to what Sarah has written for Walmart project: https://github.com/IvanekLab/Walmart/blob/master/Walmart_120419_SupplyChainModel.Rmd

Revised 10/29/20, Sarah Murphy, wrote code for school milk model, based on spore model code. School milk model is now functional, but will need review and troubleshooting, as described. The school milk model includes 3 stages: (1) storage at facility, (2) transportation from facility to schools, and (3) storage/display at schools. Unit of milk = half-pint. Current model result shows minimal growth over time, likely because of how lag is currently implemented & because temperature & time distributions still need to be reviewed. Started troubleshooting/editing code to adjust lag and mu, as needed, after temperature shifts, but need to discuss the proper way to implement. Data currently being used for defining parameters/distributions other than initial micro contamination & AT are described in the notes and are based on 10/27/2020 discussion.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Set-up environment
* load packages
* load functions
* set seed for reproducibilty
```{r}
## load packages
library(readr)
library(tidyverse)
library(censReg)
library(fitdistrplus)
library(splitstackshape)
library(rmutil)
library(truncnorm)
library(EnvStats)

## load functions
source("UtilityFunctions.R")

# removed "t" from lagAtNewTemp
lagAtNewTemp <- function (newTemp, oldLag, oldTemp = 6, T0 = -3.62) {
  numerator <- oldTemp -T0
  denom <- newTemp - T0
  newLag <- ( (numerator / denom)^2) * oldLag
  return(newLag)
}
```

```{r knitr_options , include=FALSE}
## set seed
set.seed(1)
```
## 2. Load input files
* load
```{r}
# (a) AT/ST frequency data (from Ariel_2017MC_SporeModel on MC-2020 on GitHub)
# spore
## 1. For experiment, you will change AT freq data here
spore_ATfrequency_file <- "InputFiles/ColdgrowATFreq_CrossSect.csv"
spore_ATfreq_import <- read.csv(spore_ATfrequency_file, stringsAsFactors = FALSE, header = TRUE)

# (b) growth parameter data; make sure this contains growth parameters & growth model name
# spore (from Ariel_2017MC_SporeModel on MC-2020 on GitHub)
## 2. For experiment, you will change the growth parameter data
spore_growth_file <- "InputFiles/GrowthParameters.csv" 
spore_growth_import <-read.csv(spore_growth_file, stringsAsFactors = FALSE)

# (c) initial microbial count data (from Ariel_2017MC_SporeModel on MC-2020 on GitHub)
# spore
spore_init_file <- read.csv("InputFiles/CrossSectional_RawMPN_3.6.17.csv")
```
* Modify naming in input files to be consistent across all MC-2020 model files
```{r}
spore_ATfreq_import$temp <- "AT"
spore_ATfreq_import$ClosestAT <- paste(spore_ATfreq_import$temp,spore_ATfreq_import$ClosestAT,sep="_")

spore_growth_import <- spore_growth_import %>%
  .[c(1:5)]%>%
  rename(STorAT = rpoBAT)
spore_growth_import$model_name <- "buchanan" #may change later
spore_growth_import$temp <- "AT"
spore_growth_import$STorAT <- paste(spore_growth_import$temp,spore_growth_import$STorAT,sep="_")
```

## 3. Prepare initial contamination & AT distributions using input data
a. Initial contamination: logMPN normal distribution
b. Frequency of allelic types
```{r}
## (a) Initial contamination: logMPN normal distribution
spore_init_file$log10left <- log10(spore_init_file$left)
spore_init_file$log10right <- log10(spore_init_file$right)
spore_init_file$log10MPN <- log10(spore_init_file$MPN)
cens_data <- spore_init_file[,c("log10left","log10right")]
names(cens_data) <- c("left","right")
spore_fit <- fitdistcens(censdata = cens_data,distr = "norm")
hist(spore_init_file$log10MPN,freq=F,xlim = c(-4,4))
curve(dnorm(x,mean=spore_fit$estimate[1],sd = spore_fit$estimate[2]),add=T)
plot(spore_fit)
summary(spore_fit)

spore_log10MPN_mean <- spore_fit$estimate[1]
spore_log10MPN_sd <- spore_fit$estimate[2]

## (b) Frequency of allelic types
#Here, the "distribution" of ATs are taken directly from the input file by creating a vector of the AT in each of the rows in the the column containing the AT
AT_freq <- spore_ATfreq_import$ClosestAT 
```


## 4. School milk model
3 stages:
i. Storage in facility
ii. Transportation to school (starts at end of storage at facility, includes all tranport/storage events up to arrival at school, ends at arrival at school)
iii. Storage/display at school [consider splitting this up maybe]

#Set-up dataframe for modeling school milk:
*lot_id (1:100) aka n_sim
*school_id (1:5)
*unit_id (1:10)

*t_F: duration of storage at the facilty by lot, unique for each school (in days)
*T_F: temperature during storage at the facility by lot, same for all units within same lot (in Celsius)
*newLag_F (new lag parameter for T_F for AT)
*newMu_F (new mumax parameter for T_F for AT)

*t_T: duration of transportation from facility to each school by lot (in days)
*T_T: temperature during stransportation from facility to each school by lot (in Celsius)
*newLag_T (new lag parameter for T_F for AT)
*newMu_T (new mumax parameter for T_F for AT)

*t_S: duration of storage/display at each school by lot (in days)
*T_S: temperature during storage/display at each school by lot (in Celsius)
*newLag_S (new lag parameter for T_S for AT)
*newMu_S (new mumax parameter for T_S for AT)

```{r}
n_sim <- 100 #aka n_lot 
n_school <- 5
n_units <- 10

lot_id <- rep(seq(1, n_sim), each = n_school * n_units)
school_id <- rep(seq(1,n_school), each = n_units, times=n_sim) 
unit_id <- rep(seq(1,n_units), times = n_sim *n_school) 

STorAT <- vector(mode="logical", n_sim * n_school *n_units)

#stage1, storage at facility
t_F <- vector(mode="logical", n_sim * n_school *n_units) 
T_F <- vector(mode="logical", n_sim * n_school *n_units) 
count_F <- vector(mode = "logical", n_sim * n_school *n_units)

#stage2, transport to school
t_T <- vector(mode="logical", n_sim * n_school *n_units) 
T_T <- vector(mode="logical", n_sim * n_school *n_units) 
count_T <- vector(mode = "logical", n_sim * n_school *n_units)

#stage3, storage at school
t_S <- vector(mode="logical", n_sim * n_school *n_units) 
T_S <- vector(mode="logical", n_sim * n_school *n_units) 
count_S <- vector(mode = "logical", n_sim * n_school *n_units)

data <- data.frame(lot_id, school_id, unit_id,STorAT,t_F, T_F, count_F, 
                   t_T, T_T, count_T, t_S, T_S, count_S)
```

#Get initial count and AT for each milk unit (half-pint; 237 mL)
*initial count is unique by school, lot, unit
*AT is unique by school, lot, unit
```{r}
##get initial count
spore_log10MPN_samp <- rnorm(n_sim, spore_log10MPN_mean, spore_log10MPN_sd) 
#Convert spore_log10MPN_samp back to spore_MPN_samp
spore_MPN_samp <- 10^spore_log10MPN_samp
#Convert MPN for each sample (here, unique for each simulation aka lot) to equivalent in milk unit of interest (here, unit = half pint; 237 mL in half pint)
spore_MPN_samp_halfpint <- spore_MPN_samp * 237

#Sample the MPN_init distribution
spore_MPN_init<-vector()
for (i in 1:n_sim){
  spore_MPN_init_samp <-rep(rpois(n_units*n_school, spore_MPN_samp_halfpint[i]))
  spore_MPN_init<-c(spore_MPN_init, spore_MPN_init_samp)}

#First convert spore_MPN_init from half-gallon to mLs
spore_MPN_init_mL <- spore_MPN_init / 237
data$spore_MPN_init_mL <- spore_MPN_init_mL
#Also need to remove 0's from the data and replace with detection limit
data$spore_MPN_init_mL[data$spore_MPN_init_mL<=0 ] <- 0
data$spore_MPN_init_mL[data$spore_MPN_init_mL == 0] <- 0.01;
#Add spore_log10MPN_init to dataframe
data$spore_log10MPN_init_mL <- log10(data$spore_MPN_init_mL) 

# (b) Sample AT from AT_freq & add to df
AT <- vector()
for (i in 1:n_sim){
 AT_samp <- rep(sample(AT_freq, n_units*n_school, replace = T))
  AT <- c(AT, AT_samp)}
data$STorAT <- AT
```

#Stage 1: Model storage at facility
```{r}
## (a)  Sample the temperature distribution & add to df
temps_F <- rep(runif(n_sim,min=3.5,max=4.5),each=n_units*n_school) #uniform distribution
data$T_F <- temps_F

## (b) Sample the storage time (in days) distribution & add to df
times_F <- rep(runif(n_sim*n_school,min=1,max=2),each=n_units) #uniform distribution
data$t_F <- times_F

## (c) Determine newLag_F and newMu_F
for (i in 1:(n_sim*n_units*n_school)){
  #Find row in growth parameter data that corresponds to allele sample
 allele_index <- which(spore_growth_import$STorAT == data$STorAT[i])
  
  #Calculate the new growth parameters at new temp using the square root model 
  newLag_F <- lagAtNewTemp(data$T_F[i], spore_growth_import$lag[allele_index])
  newMu_F <-  muAtNewTemp(data$T_F[i], spore_growth_import$mumax[allele_index])
  
  data$newLag_F[i] <- newLag_F
  data$newMu_F[i] <- newMu_F
}

## (d) Determine count_F
for (i in 1:(n_sim *n_units * n_school)){
  #Find row in growth parameter data that corresponds to allele sample
  allele_index <- which(spore_growth_import$STorAT == data$STorAT[i]) 
  
  #Calculate the log10N count using the new growth parameters
  data$count_F[i] <- log10N_func(data$t_F[i], data$newLag_F[i],data$newMu_F[i],data$spore_log10MPN_init_mL[i],spore_growth_import$LOG10Nmax[allele_index])
}

```

#Stage 2: Model transport from facility to school
```{r}
## (a)  Sample the temperature distribution & add to df
temps_T <- rep(rtri(n_sim*n_school,min=1.7,max=10.0,mode=4.4),each=n_units) #triangular distribution
data$T_T <- temps_T

## (b) Sample the storage time (in days) distribution & add to df
times_T <- rep(rtruncnorm(n_sim*n_school,a=0.021,b=24.00, mean=0.217,sd=0.104),each=n_units)
data$t_T <- times_T

## (c) Determine newLag_T and newMu_T
for (i in 1:(n_sim*n_units*n_school)){
  #Find row in growth parameter data that corresponds to allele sample
 allele_index <- which(spore_growth_import$STorAT == data$STorAT[i])
  
  #Calculate the new growth parameters at new temp using the square root model 
  newLag_T <- lagAtNewTemp(data$T_T[i], spore_growth_import$lag[allele_index])
  newMu_T <-  muAtNewTemp(data$T_T[i], spore_growth_import$mumax[allele_index])
  
  data$newLag_T[i] <- newLag_T
  data$newMu_T[i] <- newMu_T
}

## (d) Determine count_T
for (i in 1:(n_sim *n_units * n_school)){
  #Find row in growth parameter data that corresponds to allele sample
  allele_index <- which(spore_growth_import$STorAT == data$STorAT[i]) 
  
  #Calculate the log10N count using the new growth parameters
  data$count_T[i] <- log10N_func(data$t_T[i], data$newLag_T[i],data$newMu_T[i],data$count_F[i],spore_growth_import$LOG10Nmax[allele_index])
}

##WARNING LAG and mu still need to be adjusted; attempt to adjust below based on note from Tim, but need more information; note: using "adjustlag" function from our utility functions seems to produces a result that seems wrong

# for (i in 1:(n_sim*n_units*n_school)){
#  allele_index <- which(spore_growth_import$STorAT == data$STorAT[i])
#   
#   newLag_T <- lagAtNewTemp(data$T_T[i], spore_growth_import$lag[allele_index])
#   data$newLag_T[i] <- newLag_T
#   
#   remainingLag <- data$newLag_F[i] - data$t_F[i]
#   data$remainingLag[i] <- remainingLag
#   
#   adjNewLag_T <- 0.25*data$newLag_T[i]
#   data$adjNewLag_T[i] <-adjNewLag_T
#   
#   data$LagT[i] <- data$remainingLag[i]+data$adjNewLag_T[i]
#   
#   data$LagT2[i]<-adjustLag(data$t_F[i], data$newLag_F[i], data$newLag_T[i])
# }
```

#Stage 3: Model storage/display at school
**Warning: see above comment about needing to troubleshoot lag & mu adjustments btwn stages**
```{r}
## (a)  Sample the temperature distribution & add to df
temps_S <- rep(rtruncnorm(n_sim*n_school,a=-1.4,b=5.4,mean=2.3,sd=1.8),each=n_units) #triangular distribution
data$T_S <- temps_S

## (b) Sample the storage time (in days) distribution & add to df
times_S <- rep(rtruncnorm(n_sim*n_school,a=0.042,b=10.0, mean=1.821,sd=3.3),each=n_units)
data$t_S <- times_S

## (c) Determine newLag_S and newMu_S
for (i in 1:(n_sim*n_units*n_school)){
  #Find row in growth parameter data that corresponds to allele sample
 allele_index <- which(spore_growth_import$STorAT == data$STorAT[i])
  
  #Calculate the new growth parameters at new temp using the square root model 
  newLag_S <- lagAtNewTemp(data$T_S[i], spore_growth_import$lag[allele_index])
  newMu_S <-  muAtNewTemp(data$T_S[i], spore_growth_import$mumax[allele_index])
  
  data$newLag_S[i] <- newLag_S
  data$newMu_S[i] <- newMu_S
}

## (d) Determine count_S
for (i in 1:(n_sim *n_units * n_school)){
  #Find row in growth parameter data that corresponds to allele sample
  allele_index <- which(spore_growth_import$STorAT == data$STorAT[i]) 
  
  #Calculate the log10N count using the new growth parameters
  data$count_S[i] <- log10N_func(data$t_S[i], data$newLag_S[i],data$newMu_S[i],data$count_T[i],spore_growth_import$LOG10Nmax[allele_index])
}
```

# Save dataset
```{r}
data_schoolmilk <- data
```

Quick fix for now...
Set anything with <1 cfu/half-pint to zero (since in cfu/mL; replace < -2.374 log10 cfu/mL (approx. 1 cfu/half-pint) w/ -6 log10 cfu/g which is very close to 0 if back calculate 10^-6*237 = 0.000237) 
```{r}
# if inital count (i.e., spore_log10MPN_init_mL) was < -3.278 log10 cfu/g, then no grow during shelf life

#no intervention
data_schoolmilk$count_F_original <- data_schoolmilk$count_F
data_schoolmilk$count_T_original <- data_schoolmilk$count_T
data_schoolmilk$count_S_original <- data_schoolmilk$count_S

data_schoolmilk$count_F <- ifelse(data_schoolmilk$spore_log10MPN_init_mL < -2.374, -6, data_schoolmilk$count_F_original)
data_schoolmilk$count_T <- ifelse(data_schoolmilk$spore_log10MPN_init_mL < -2.374, -6, data_schoolmilk$count_T_original)
data_schoolmilk$count_S <- ifelse(data_schoolmilk$spore_log10MPN_init_mL < -2.374, -6, data_schoolmilk$count_S_original)

#reorder columns in dataframe
data_schoolmilk <-data_schoolmilk[c(1:4,15,7,10,13,5,8,11,6,9,12,14,16:24)]

#now, save data
# save(data_schoolmilk, file = "data_schoolmilk.RData")
```


## Notes from 10/27/2020 meeting Sarah & Tim
Original proposed steps
i. Storage in facility
ii. Transport to distribution center [SKIP FOR NOW]
iii. Storage in distribution center [SKIP FOR NOW]
iv. Transport to retail (or school)
v. Storage/display at retail
vii. Transport to home
viii. Storage at home

V-school
i. Storage in facility
ii. Transportation to school (starts at end of storage at facility, includes all tranport/storage events up to arrival at school, ends at arrival at school)
iii. Storage/display at school [consider splitting this up maybe]

V-retail (retail -> home)
i. Storage in facility
ii. Transportation to retail (starts at end of storage at facility, includes all tranport/storage events up to arrival at retail, ends at arrival at retail)
iii. Storage/display at retail
iv. Transport to home
v. Storage at home

**detailed notes:
V-school
i. Storage in facility
* unit = half-pint (aka 8 oz); 237 mL (start modeling 50 units per lot, 10 per each school)
* each unit from the same lot is assigned the same temperature (because represents storage at facility)
* constant temperature for duration of the storage
* duration of storage (aka time) is different for each school (modeling 5 schools); based on Tim's data: mean 36 h, sd 10 h, min 23, max 48 (again, this is temporary, change later), for now, uniform distribution w/ 24, 48 h
* distribution for temperature for storage at facility; uniform distribution, w/ 3.5 to 4.5 degrees Celsius (obtained from data collection)

ii. Transportation to school (starts at end of storage at facility, includes all tranport/storage events up to arrival at school, ends at arrival at school)
* unit = half-pint (aka 8 oz); 237 mL (start modeling 50 units per lot, 10 per each school)
* units for each school are assigned different temperature (because represents transport to different schools); units from the same school are assigned the same temperature
* constant temperature for duration of the storage
* duration of transportation is different for each school (modeling 5 schools); from Tim's small dataset (3 data points) had mean 5.2 h, sd 0.6 h, min 4.5 h, max 5.9 h; compare to triangular distribution from FDA assessment for retail transport duration was: min 1 day, max 10 day, mode 5 days (obtained from page 89; https://www.fda.gov/media/90488/download); TEMPORARILY use truncated normal distribution w/ mean 5.2 h, sd 2.5 h, truncate [0.5h, 24 h aka 1 day] (model in fractions of day) 
* distribution for temperature for transportation to school; triangular distribution, w/ min 1.7, max 10.0, mode 4.4 degrees Celsius (obtained from page 89 https://www.fda.gov/media/90488/download; for retail transport; original data from expert elicitation IDFA 2008 cited in paper).

iii. Storage/display at school [consider splitting this up maybe]
* unit = half-pint (aka 8 oz); 237 mL (start modeling 50 units per lot, 10 per each school)
* units for each school are assigned different temperature (because represents storage/display at different schools); units from the same school are assigned the same temperature
* constant temperature for duration of the storage
* duration of storage is different for each school (modeling 5 schools); Tim will look back at survey data to get specifics for schools; for now, use retail data from 2013 MQIP study (27 data points), truncated normal, w/ mean 43.7 h, sd 79.2 h, min 1.0 h, max 240 h, median 24 h
* distribution for temperature for storage/display at school [use retail temps for now from 2013 Upstate NY retail storage temperature study MQIP, Tim obtain through data collection in future]; truncated normal distribution, w/ mean 2.3, standard deviation 1.8, at least temporarily use minimum and maximum for truncating, which are -1.4C min, 5.4 maximum (see similar example of implementation page 91 https://www.fda.gov/media/90488/download)

**more notes
Growth Parameters
	- Model microbial growth with shifts in temperature
	- Use approach outlined in Hypothesis III from (Zwietering et al 1994)
	- Lag: Assumes additional lag phase + 25% of lag phase at new temperature
	- Maximum Growth Rate: Assumes 25% of lag phase at new temperature before continuing growth rate 	at new temperature
	
To start, model each stage as a new "chunk" like Sarah did here: https://github.com/IvanekLab/Walmart/blob/master/Walmart_120419_SupplyChainModel.Rmd





