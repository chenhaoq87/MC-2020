---
title: "MilkSpoilageTyping"
author: "Sarah I. Murphy"
date: "5/13/2021"
output: html_document
---
1/28/21 - Sarah Murphy created RmD file for prepping data for spoilage typing
4/29/21 - Sarah Murphy edited code since got updated VSL dataset from Tim Lott named "VSL_Jul18toMay19.xlsx"; there are still some issues with the dataset Tim sent me (e.g., dataset doesn't include CVTA data) so emailed to ask for updated dataset 
5/5/21 - Sarah Murphy uploaded revised VSL dataset from Tim Lott named "Jul18-May19VSL_050321.xlsx". Wrote code here for spoilage typing, based in part by code from "SpoilageTypeAssignments" (old file). Next step is to go through the 8 samples that need to "REVIEW" in order to assign spoilage type and then ask others to review code.
5/11/21 AM - Sarah Murphy reviewed this code with Al Trmcic, Tim Lott, and Sam Lau; for samples that still need to be reviewed, will send email with this code ("SpoilageTyping_Prep.Rmd") and data ("sdf_forReview_051121.csv") to be reviewed to come up with additional rules for spoilage typing
5/11/21 PM - Sarah Murphy wrote code for the rule Al suggested. Also wrote code such that for cases of below LOD, replaced with 25% LOD. Added summary at end of RMD w/ total number of each spoilage type from given dataset (for the dataset described above, 50 samples did not spoil by the end of shelf-life testing ("NotSpoiled"), 116 samples spoiled due to PPC ("ppc"), 103 samples spoiled due to sporeformers ("spore"). Also wrote code so users can have separate datasets for "ppc" samples only and "spore" samples only. Next step is to edit the combined model code.
5/12/21 & 5/13/21 - Sarah Murphy renamed document as "MilkSpoilageTyping.Rmd". Added some annotations to code & cleaned it up a bit. Removed the rule Al had suggested (discussed in modeling group meeting that these samples should still be reviewed). Note that also prepared an image depicting the spoilage typing rules as a decision diagram (PDF & PPT); also, saved sdf_full to share with others for review and moved the spore only file to Archive since outdated.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Load packages
```{r}
library(readxl)
library(dplyr)
library(tidyr)
```

*Load data
```{r}
df <- read_excel("Jul18-May19VSL_050421.xlsx")
```

*Prep data
```{r}
#rename projectNumber to VSLNumber
colnames(df)[1] <- "VSLNumber"

# only use pasteurized fluid white milk; thus, sampleID should be either 1, 2, 3, or 4 from the right (after removing "-" to the left)
df$sampleID<- trimws(df$sampleID, which = c("both")) #make sure no whitespace
df$temp <- df$sampleID
df <- df %>%
  separate(temp,c("id1","id2"),sep="-") #ignore warning, for some there is no "-" so it's OK 
df <- df %>%
  separate(id1,c("id3","milkType"),sep=-1)
dfw <- df %>%
  filter(milkType == "1"|milkType == "2"|milkType == "3"|milkType == "4") #only include white milk

# prep dfw
dfw$VSLNumber_SampleID <- paste(dfw$VSLNumber,dfw$sampleID,sep="_")
dfw$Test_Day <- paste(dfw$test,dfw$Day,sep="_")

dfw$Plant_VSLNumber_SampleID <- paste(dfw$plantID,dfw$VSLNumber_SampleID,sep="_")
dfw$countability[is.na(dfw$countability)==TRUE] <- "OK"

dfw$countability <- as.factor(dfw$countability)
summary(dfw$countability)
#reviewed countability; all were either OK, "E" (estimated), "S" (spreader) or "L" (lab error); filter out "lab error" 
dfw <- dfw %>%
  filter(countability!="L")

# # convert dates to appropriate format 
dfw$dateInitial <- as.Date(dfw$dateInitial,'%Y-%m-%d')
# dfw$dateCollected <- as.Date(dfw$dateCollected,'%Y-%m-%d')
dfw$dateProcessed<- as.Date(dfw$dateProcessed,'%Y-%m-%d')
dfw$Day_Initial_Actual<- difftime(dfw$dateInitial,dfw$dateProcessed, units = "days") # days
dfw <-separate(data=dfw, Day, c("D", "day"), sep = 1, remove = FALSE)
dfw$sl_day <- ifelse(dfw$Day=="DI", dfw$Day_Initial_Actual, dfw$day) #this is actual shelf-life day

#add count_type based on greaterThanLessThan
dfw$count_type <- dfw$greaterThanLessThan
dfw$count_type[dfw$greaterThanLessThan=="<"]<-"belowLOD" ##replace with 25% detection limit
dfw$count_type[dfw$greaterThanLessThan==">"]<-"aboveLOD" ##make a decision about this; check literature
dfw$count_type[is.na(dfw$greaterThanLessThan)==TRUE]<-"OK"

#replace counts marked below LOD, with 25% of detection limit (i.e., 25% of the recorded dataValue)
dfw$count <- ifelse(dfw$count_type=="belowLOD", dfw$dataValue*0.25, dfw$dataValue) 

#
dfw2 <- dfw[c(23,28,24)] %>%
  spread(.,Test_Day,count)
# dfw2 <- dfw[c(23,16,24)] %>%
#   spread(.,Test_Day,dataValue)

dfw$LODtemp <- "LOD"
dfw$LOD_Test_Day <- paste(dfw$LODtemp,dfw$Test_Day,sep="_")
dfw2b <- dfw[c(27,30,24)] %>%
  spread(.,LOD_Test_Day,count_type)
dfw2b[is.na(dfw2b)==TRUE] <- "OK"

dfw2_merged <- merge(dfw2,dfw2b,by="Plant_VSLNumber_SampleID")
temp <- unique(dfw[c(24,25)])
dfw2_merged2 <- merge(dfw2_merged,temp,by="Plant_VSLNumber_SampleID")
dfw2_merged2<- separate(data=dfw2_merged2, Plant_VSLNumber_SampleID,c("Plant", "VSLNumber", "SampleID"),sep="_")
dfw2_merged2$Day_Initial_Actual <- as.numeric(dfw2_merged2$Day_Initial_Actual)
dfw2_merged2 <- dfw2_merged2[c(1:3,28,4:27)]

dfw2_merged2[is.na(dfw2_merged2)==TRUE] <- "NotTested"
#rename dfw2_merged2 to sdf
sdf<-dfw2_merged2

#clean-up environment
rm(df,dfw2_merged,temp,dfw2,dfw2b)
```

*Assign spoilage types
```{r}
sdf$SPC_DI<- as.numeric(sdf$SPC_DI)
sdf$SPC_D7<- as.numeric(sdf$SPC_D7)
sdf$SPC_D10<- as.numeric(sdf$SPC_D10)
sdf$SPC_D14<- as.numeric(sdf$SPC_D14)
sdf$SPC_D17<- as.numeric(sdf$SPC_D17)
sdf$SPC_D21<- as.numeric(sdf$SPC_D21)

sdf[c("SPC_DI", "SPC_D7","SPC_D10","SPC_D14","SPC_D17","SPC_D21")][is.na(sdf[c("SPC_DI", "SPC_D7","SPC_D10","SPC_D14","SPC_D17","SPC_D21")])] <- 0 #replace NA with 0 for select columns so can use for later steps

sdf$CVTA_DI<- as.numeric(sdf$CVTA_DI)
sdf$CVTA_D7<- as.numeric(sdf$CVTA_D7)
sdf$CVTA_D10<- as.numeric(sdf$CVTA_D10)
sdf$CVTA_D14<- as.numeric(sdf$CVTA_D14)
sdf$CVTA_D17<- as.numeric(sdf$CVTA_D17)
sdf$CVTA_D21<- as.numeric(sdf$CVTA_D21)

sdf[c("CVTA_DI", "CVTA_D7","CVTA_D10","CVTA_D14","CVTA_D17","CVTA_D21")][is.na(sdf[c("CVTA_DI", "CVTA_D7","CVTA_D10","CVTA_D14","CVTA_D17","CVTA_D21")])] <- 0 #replace NA with 0 for select columns so can use for later steps

##Assign spoilage types: ppc, spore, or NotSpoiled; first, where >20,000 means spoilage, hashed out is alternative where >1,000,000 means spoiled
sdf$Spoiled20000_yn <- ifelse((sdf$SPC_DI>20000 | sdf$SPC_D7>20000 | sdf$SPC_D10>20000| sdf$SPC_D14>20000| sdf$SPC_D17>20000| sdf$SPC_D21>20000), "yes", "NotSpoiled") 
# sdf$Spoiled1mill_yn <- ifelse((sdf$SPC_DI>1000000 | sdf$SPC_D7>1000000 | sdf$SPC_D10>1000000| sdf$SPC_D14>1000000| sdf$SPC_D17>1000000| sdf$SPC_D21>1000000), "yes", "no") 

sdf$AnyGN_yn <- ifelse((sdf$CVTA_DI>1000 | sdf$CVTA_D7>1000 | sdf$CVTA_D10>1000| sdf$CVTA_D14>1000| sdf$CVTA_D17>1000| sdf$CVTA_D21>1000), "yes", "no") 

sdf$exceed20000byD10_yn <- ifelse((sdf$SPC_DI>20000 | sdf$SPC_D7>20000 | sdf$SPC_D10>20000), "yes", "no") 

sdf$exceed100000postD10_yn <- ifelse(sdf$exceed20000byD10_yn == "no" & (sdf$SPC_D14>100000 | sdf$SPC_D17>100000 | sdf$SPC_D21>100000), "yes", "no") 

sdf$CVTA_max <- sdf[, "max"] <- apply(sdf[, 5:10], 1, max)
sdf$SPC_max <- sdf[, "max"] <- apply(sdf[, 11:16], 1, max)
sdf$HigherSPC_yn <- ifelse((sdf$CVTA_max*10 > sdf$SPC_max), "yes", "no")

sdf$temp1 <- ifelse(sdf$CVTA_DI>1000,1,0)
sdf$temp2 <-ifelse(sdf$CVTA_D7>1000,1,0)
sdf$temp3 <-ifelse(sdf$CVTA_D10>1000,1,0)
sdf$temp4 <-ifelse(sdf$CVTA_D14>1000,1,0)
sdf$temp5 <-ifelse(sdf$CVTA_D17>1000,1,0)
sdf$temp6 <-ifelse(sdf$CVTA_D21>1000,1,0)
# sdf[c("temp1", "temp2","temp3","temp4","temp5","temp6")][is.na(sdf[c("temp1", "temp2","temp3","temp4","temp5","temp6")])] <- 0 #replace NA with 0 for select columns so can use for next step
sdf$tempadd <- sdf$temp1 + sdf$temp2 + sdf$temp3 + sdf$temp4 + sdf$temp5 + sdf$temp6
sdf$GN_AtLeast2x <- ifelse(sdf$tempadd>1,"yes","no")

##Implement rules for assigning spoilage types (i.e., spore, ppc, or NotSpoiled)
sdf$spoilagetype2 <- paste(sdf$Spoiled20000_yn,sdf$exceed20000byD10_yn,sdf$AnyGN_yn,sep="_")

sdf$spoilagetype[sdf$Spoiled20000_yn=="NotSpoiled"]<-"NotSpoiled"
sdf$spoilagetype[sdf$spoilagetype2=="yes_yes_yes"]<-"ppc"
sdf$spoilagetype[sdf$spoilagetype2=="yes_yes_no"]<-"spore" #likely ppc with a gram-positive (growth not delayed due to germination--vegetative cells), therefore call it "spore"
sdf$spoilagetype[sdf$spoilagetype2=="yes_no_no"]<-"spore"
sdf$spoilagetype[sdf$spoilagetype2=="yes_no_yes"]<-"REVIEW"
sdf$spoilagetype[sdf$GN_AtLeast2x=="no" &sdf$spoilagetype=="REVIEW"]<-"spore"
sdf$spoilagetype[sdf$exceed100000postD10_yn=="yes" &sdf$spoilagetype=="REVIEW"]<-"spore" #we looked at data and when jump happened, used that
# sdf$spoilagetype[sdf$spoilagetype=="REVIEW" &sdf$HigherSPC_yn=="no"]<-"spore" #Don't do this anymore
# sdf$spoilagetype[sdf$spoilagetype=="REVIEW" &sdf$HigherSPC_yn=="yes"]<-"ppc"

##After this step, merge old dfw2_merged with the sdf with only the spoilage typing relevant columns
sdf2<- sdf[c(1:4,29:32,36,44,46,17:28)]
sdf2$temp <- paste(sdf2$Plant,sdf2$VSLNumber,sep="_")
sdf2$Plant_VSLNumber_SampleID <- paste(sdf2$temp,sdf2$SampleID,sep="_")

dfw2_merged3 <- dfw2_merged2[c(1:3,5:16)]
dfw2_merged3$temp <- paste(dfw2_merged3$Plant,dfw2_merged3$VSLNumber,sep="_")
dfw2_merged3$Plant_VSLNumber_SampleID <- paste(dfw2_merged3$temp,dfw2_merged3$SampleID,sep="_")

sdf_full <- merge(sdf2,dfw2_merged3[c(4:15,17)],by="Plant_VSLNumber_SampleID")

#Check to see if any samples need to be REVIEWED to assign spoilage type still
# reviewdf <- sdf_full %>%
#   filter(spoilagetype=="REVIEW") 

#reorder columns
sdf_full <- sdf_full[c(2:12,37,36,32:35,31,30,26:29,24,23,19:22,18,17,13:16,1)]
# write.csv(sdf_full,"sdf_full_051321.csv")
```

*Summarize spoilage typing results
```{r}
#how many samples of each spoilage type?
sdf_full$spoilagetype <- as.factor(sdf_full$spoilagetype)
summary(sdf_full$spoilagetype)
```

*Prep separate subsets for ppc samples and spore samples
```{r}
#prepare subsets with PPC samples only & with spore samples only
sdf_ppc <- sdf_full %>%
  filter(spoilagetype=="ppc")

sdf_spore <- sdf_full %>%
  filter(spoilagetype=="spore")
```


