---
title: "MCsim_020620"
author: "Sarah I. Murphy"
date: "2/6/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Set-up environment
* load packages
* load functions
* set seed for reproducibilty
```{r}
## load packages
library(readr)

## load functions
source("UtilityFunctions.R")

## set seed
set.seed(1)
```

## 2. Load input files
```{r}
#(a) frequency data
frequency_file <- "Frequency.csv"
freq_import <- read.csv(frequency_file, stringsAsFactors = FALSE, header = TRUE)

#(b) growth parameter data
growth_file <- "GrowthParameters.csv" #make sure this contains growth parameters & growth model name
growth_import <-read.csv(growth_file, stringsAsFactors = FALSE)

#(c) initial count logMPN data
init_file <- "InitialCountsMPN.csv"
initialcount_import <- read.csv(init_file, stringsAsFactors = FALSE)

#(d) temperature data for each stage (Note for Sarah to fix temp_stages format)
temp_stages_file <- "temp_stages.csv"
temp_by_stage <- read.csv(temp_stages_file, stringsAsFactors = F, comment.char = "#")
```

## 3. Set-up dataframe

i. Set important parameters for running the simulation:
```{r}
# (a) n_sim
# Definition: Number of simulations to run (also referred to as the number of bulk tanks in earlier code; i.e., 1 simulation unit = 1 bulk tank of milk)
n_sim <-100    #1000 is for testing and exploring, experiments require at least 10k

# (b) n_units 
# Definition: Number of units per lot (currently, half gallon units) 
n_units <-10

# (c) start_day 
# Definition: First time point (in days) in unit's shelf life to simulate
start_day <- 1 

# (d) end_day 
# Definition: Last time point (in days) in unit's shelf life to simulate
end_day <- 24 
n_day <- 24 # seems like this is the end_day, but keeping code below for now in case my interpretation is wrong
```

ii. Prep vectors using defined values above
```{r}

# (a) bulk_tank
#Make a vector for "bulk tank" by repeating sequence of 1:n_sim for length of n_units * n_day
bulk_tank <- rep(seq(1, n_sim), each = n_units * n_day)

# (b) milk_unit
#Make a vector for "milk_unit" by repeating the sequence of 1:n_units by n_day * n_sim
milk_unit <- rep(seq(1, n_units), times = n_day * n_sim) 

# (c) AT
# Make an empty vector for "AT" with the length of n_sim * n_units * n_day
AT <- vector(mode="logical", n_sim * n_units * n_day) 

# (d) day
#Make a vector repeating days in shelf life that are simulated for each simulation run (i.e., each bulk tank) 
day <- rep(rep(seq(start_day, start_day+n_day-1), each = n_units), times = n_sim) 

# (e) count
#Make an empty vector for "count" with the length of n_sim * n_units * n_day
count <- vector(mode = "logical", n_sim * n_units * n_day) 
```

iii. Prep dataframe using vectors above (each vector becomes a column)
```{r}
data <- data.frame(bulk_tank, milk_unit, AT, day, count)
```

## 4. Prepare distributions using input data
a. Initial contamination: logMPN normal distribution
b. Frequency of allelic types
c. Temperature distribution for each stage 
```{r}
## (a) Initial contamination: logMPN normal distribution (note: How is the initialcount_import data used? Where did logMPN_mean and logMPN_sd come from?)
# initialcount_data = initialcount_import[,3]
# initialcountlog_data = initialcount_import[,4]

#Set mean and sd to use for normal distribution
logMPN_mean <- c(-0.7226627) 
logMPN_sd <- c(.9901429) 

## (b) Frequency of allelic types
#Here, the "distribution" of ATs are taken directly from the input file by creating a vector of the AT in each of the rows in the the column containing the AT

AT_freq <- freq_import$rpoB.allelic.type 

## (c) Temperature distribution for each stage (Note for Sarah to fix)
#Here, the distribution and parameters are currently already written into the input file
temp_by_stage

```

## Sample distributions
```{r}
#Sample logMPN distribution
logMPN_samp = rnorm(n_sim, logMPN_mean, logMPN_sd) 

#Convert logMPN_samp back to MPN_samp
MPN_samp = 10^logMPN_samp 

#Convert MPN for each sample (here, unique for each simulation aka bulk tank) to equivalent in milk unit of interest (here, unit = half gallon; 1892.71 mL in half gallon)
MPN_samp_halfgal = MPN_samp * 1900
```

## Calculate samples used in the monte carlo
+ Now sample the MPN distributions and the temperature distribution
```{r}
#Generate initial MPN for each half gallon from Poisson distribution
#Also sample AT for each half gallon
MPN_init<-vector()
allele <- vector()
temps <- vector()
for (i in 1:n_sim){
  MPN_init_samp <-rep(rpois(n_halfgal, MPN_samp_halfgal[i]), times = n_day)
  MPN_init<-c(MPN_init, MPN_init_samp)
  allele_samp <- rep(sample(freq_data, n_halfgal, replace = T), times = n_day)
  allele <- c(allele, allele_samp)
  #now calculate temp
  for (j in 1:nrow(stages)){
    stage_row <- stages[j, ]
    n_times <- stage_row$endTime - stage_row$beginTime + 1
    params <- as.numeric(unlist(strsplit(stage_row$parameters, " ")))
    temp_mean <- params[[1]]
    temp_sd <- params[[2]]
    temp_sample <- rep(rnorm(n_halfgal, temp_mean, temp_sd), times = n_times)
    temps <- c(temps, temp_sample)
  }
}
#add in temperature
data$temp <- temps
```

```{r}
#Convert MPN_init from half-gallon to mLs
MPN_init_mL <- MPN_init / 1900
#remove 0's from the data and replace with detection limit
MPN_init_mL[MPN_init_mL == 0] <- 0.01;

#Now we add in those calculations to our original dataframe
data$logMPN_init <- log10(MPN_init_mL) #Add initial logMPN to data frame
data$AT<-allele #Add in AT data

data$newTemp <- vector(mode="logical", n_sim * n_halfgal * n_day)
data$newMu<- vector(mode="logical", n_sim * n_halfgal * n_day)
data$newLag <- vector(mode="logical", n_sim * n_halfgal * n_day)
```


