---
title: "PPC Model"
output: html_notebook
---
```{r}
#use a seed value for reproducibility
seed_value = 42;    #can be any number
```

+ Include all library packages that need to be downloaded and used
```{r}
library(splitstackshape)
library(dplyr)
library(ggplot2)
library(readr)
library(MASS)
```
# Data frame creation and setup   ----

DONT RUN THIS
```{r}
#Size is for n_sim bulk tanks, n_half_gal half gallon lots, n_day days
n_sim <-100    #1000 is for testing and exploring, experiments require at least 10k
n_halfgal <-10
n_day <- 24
start_day <- 1

#Repeat each element of the sequence 1..n_sim.Bulk tank data (MC runs)
BT <- rep(seq(1, n_sim), each = n_halfgal * n_day)
#Repeat the whole sequences times # of times
half_gal <- rep(seq(1, n_halfgal), times = n_day * n_sim)
#Vector of FALSE
AT <- vector(mode="logical", n_sim * n_halfgal * n_day)
#Repeat the days for each simulation run
day <- rep(rep(seq(start_day, start_day+n_day-1), each = n_halfgal), times = n_sim)
count <- vector(mode = "logical", n_sim * n_halfgal * n_day)

#matrix with columns:
#  BT   half_gal    AT    day   count
data <- data.frame(BT, half_gal, AT, day, count)
```


+ Set up data frame to store count at each day
```{r}
#Size is for n_sim bulk tanks, n_half_gal half gallon lots, n_day days (14-24)
n_sim <-100    #1000 is for testing and exploring, experiments require at least 10k
n_halfgal <-10
n_day <- 14
start_day <- 1

#Repeat each element of the sequence 1..n_sim.Bulk tank data (MC runs)
BT <- rep(seq(1, n_sim), each = n_halfgal * n_day)
#Repeat the whole sequences times # of times
half_gal <- rep(seq(1, n_halfgal), times = n_day * n_sim)
#Vector of FALSE
AT <- vector(mode="logical", n_sim * n_halfgal * n_day)
#Repeat the days for each simulation run
day <- rep(rep(seq(start_day, start_day+n_day-1), each = n_halfgal), times = n_sim)
count <- vector(mode = "logical", n_sim * n_halfgal * n_day)

#matrix with columns:
#  BT   half_gal    AT    day   count
data <- data.frame(BT, half_gal, AT, day, count)
```

+ Import the data from our input files and begin filling in our data frames
```{r}
#input files
frequency_file <- "Frequency_ONLYSAMISOLATES_100819.csv"
growth_file <- "GrowthParameters_102819.csv"
init_file <- "InitialCount_25percent_SL_101619.csv"
```

+ Troubleshooting
  + ST 13 and 23 have growth rates that are much higher than all the other ST
  + May be contributing to why samples are spoiling so early on
```{r}
#input files
frequency_file <- "Frequency_ONLYSAMISOLATES_remove13and23_020120.csv"
growth_file <- "GrowthParameters_remove13and23_020120.csv"
init_file <- "InitialCount_25percent_SL_101619.csv"
```



+ Import frequency data and get the 16S sequence type
```{r}

freq_import <- read.csv(frequency_file, stringsAsFactors = FALSE, header = TRUE)
freq_data = freq_import$X16S_ST
freq_vec<-as.vector(freq_data) #before running sensitivity analysis (below) put a hashtag in front of this

```

+ Frequency sensitivity analysis
  + Currently with ST 13 as 30
```{r}
#make dataframe that has all the frequency data
freq_df1 <- as.data.frame(freq_data)

#whatever proportion you want to increase it to
#change prop a , 0.4 is not 40%
prop_a <- 0.4 #organize data this way so we can easily change it for sensitivity analysis

#make a dataframe that only has the desired sequence type in it there
freq_df_a <- freq_df1 %>%
  filter(freq_df1$freq_data==13) #change sequence type here 

#frequency table for a which is the ST of interest
prop_freq_df_a <- as.data.frame(prop.table(table(freq_df_a)))
prop_freq_df_a$Freq2 <- prop_freq_df_a$Freq*prop_a*100 #so now the ST is at the designated frequency you want
names(prop_freq_df_a)[1] <- "ST"

#do same for freq b
#keep everything but ST 13
freq_df_b <- freq_df1 %>%
 filter(freq_df1$freq_data!=13) #change sequence type here 
prop_freq_df_b <- as.data.frame(prop.table(table(freq_df_b)))


# #you know you want sequence type 13 to be 40%
# #you want the rest to be 60%
# #you want the 60% relative to the proportion we had before
# #force it to be 60%
prop_freq_df_b$Freq2 <- prop_freq_df_b$Freq*(1-prop_a)*100
names(prop_freq_df_b)[1] <- "ST"

sum(prop_freq_df_b$Freq2) #this should be 60

#bind rows together
prop_freq_df_ab <-rbind(prop_freq_df_a,prop_freq_df_b)
#sum(prop_freq_df_ab) #should be 100

#dont understand what's going on here

#takes whatever you had in the relative proportion
#IT HAS TO BE GREATER THAN 1
#IF ITS LESS THAN 1, you would have to multiply it by a number
#you can expand the rows to 1000 if you have a frequency that is less than 1
freq_df <- expandRows(prop_freq_df_ab,'Freq2')$ST
# 
freq_vec<-as.vector(freq_df)
rm(freq_df_a,freq_df_b,freq_df1,freq_import,prop_freq_df_a,prop_freq_df_ab,prop_freq_df_b)
```

+ Import growth and initial count parameter
```{r}
#Import growth parameter data
growth_import <-read.csv(growth_file, stringsAsFactors = FALSE)
colnames(growth_import)[1]<-c("ST")

#Import initial count logMPN data
initialcount_import <- read.csv(init_file, stringsAsFactors = FALSE)
#MPN Column
initialcount_data = initialcount_import[,2]
#LOG MPN Column
initialcountlog_data = initialcount_import[,3]
```

## Calculate samples used in the monte carlo

+ Now sample the initial concentration distributions 
```{r}
#logMPN_mean and logMPN_sd is based on initial microbial distribution
logMPN_mean <- c(0.2661982) #original
logMPN_sd <- c(0.9735963) #original
#logMPN_mean <- c(5.309379) #day7 value
#logMPN_sd <- c(1.817474) #day7 value
#logMPN_mean <- c(7.583818) #day10 value
#logMPN_sd <- c(0.6153948) #day10 value
logMPN_samp = rnorm(n_sim, logMPN_mean, logMPN_sd)
MPN_samp = 10^logMPN_samp
MPN_samp_halfgal = MPN_samp * 1900 #MPN per half gallon (1892.71 mL in half gallon)


#how the logMPN_mean and logMPN_sd was calculated for initial microbial concentration data
#mean(day7counts$count)
#sd(day7counts$count)
#mean(day10counts$count)
#sd(day10counts$count)
```

+ Sample temperature from normal distribution
```{r}
#temp_mean and temp_sd will be 6.0 and 0.0, respectively, WHEN VALIDATING AGAINST VSL DATA
#data from Consumer Phase Risk Assessment for Listeria monocytogenes in Deli Meats (2006)
#temp_mean <- 4.096
#temp_sd <-   2.381
temp_mean <- 6.0
temp_sd <-   0.0
temp_sample <- rnorm((n_sim), temp_mean, temp_sd)
```

+ Generate initial concentation for each half gallon from Poisson distribution
```{r}
#Also sample ST for each half gallon
MPN_init<-vector()
allele <- vector()
for (i in 1:n_sim){
  MPN_init_samp <-rep(rpois(n_halfgal, MPN_samp_halfgal[i]), times = n_day)
  MPN_init<-c(MPN_init, MPN_init_samp)
  allele_samp <- rep(sample(freq_vec, n_halfgal, replace = T), times = n_day) 
  allele <- c(allele, allele_samp)
}

#Convert MPN_init from half-gallon to mLs
MPN_init_mL <- MPN_init / 1900
#remove 0's from the data and replace with detection limit
MPN_init_mL[MPN_init_mL == 0] <- 0.01;

#EDIT THIS SO I CAN TRY TO MATCH THE VSL DATA AS CLOSELY AS POSSIBLE
#TAKE THIS OUT LATER, used so the initial microbial concentration would be at log -1
#MPN_init_mL<-0.004

data$logMPN_init <- log10(MPN_init_mL) #Add initial logMPN to data frame
```

+ Sensitivity analysis for initial microbial concentration
  + To change the initial microbial concentration you need to add or subtract the desired log
  + Ex: If you want to + 1 log to your initial microbial concentration, the code would look like
        data$logMPN_init <- log10(MPN_init_mL)+1
  + Ex: If you want to start at 1 log lower than your stated initial microbial concentration, the code would
        be data$logMPN_init <- log10(MPN_init_mL)-1
```{r}
data$logMPN_init <- log10(MPN_init_mL)+1 #Add initial logMPN to data frame
```

```{r}

data$AT<-allele #Add in AT data

##Now we will calculate the log10N for each row in the data frame
##Get the AT and day from the data frame, get growth parameters depending on the AT
```


# Simulation   ----
```{r}
#growth_import$ST<-as.factor(growth_import$ST)
#df<-as.data.frame(data)
#data$AT<-as.factor(data$AT)
for (i in 1:(n_sim *n_halfgal * n_day)){
  #Find row in growth parameter data that corresponds to allele sample
  allele_index <- which(growth_import$ST == data$AT[i]) 
  
  #calculate the new growth parameters using the square root model and our
  #sampled temperature
  newT <- temp_sample[data$BT[i]]
  newLag <- lagAtNewTemp(newT, growth_import$lag[allele_index])
  newMu <-  muAtNewTemp(newT, growth_import$mu[allele_index])
  
  #Calculate the log10N count using our new growth parameters
  #multiply log10N(data$day[i] by 24 since I did it in hours, not days, and ariel did it in days
  data$count[i] <- log10N(data$day[i]*24, newLag, newMu,data$logMPN_init[i],growth_import$Nmax[allele_index],growth_import$modelname[allele_index])

}
```

+ Sensitivity analysis for lag and mu
  + To change lag or mu, you need to multiply it by the desired percent change
  + Ex: if you wanted to increase lag by 20%, you would multiply newLag by 1.2
  + Ex: if you wanted to decrease lag by 20%, you would multiply newLag by 0.8
  + Ex: if you wanted to increase mu by 20%, you would multiply newMu by 1.2
  + Ex: if you wanted to decrease mu by 20%, you would multiply newMu by 0.8
  + Ex: if you didn't want a lag phase, you would multiply newLag by 0
```{r}
for (i in 1:(n_sim *n_halfgal * n_day)){
  #Find row in growth parameter data that corresponds to allele sample
  allele_index <- which(growth_import$ST == data$AT[i]) 
  
  #calculate the new growth parameters using the square root model and our
  #sampled temperature
  newT <- temp_sample[data$BT[i]]
  newLag <- lagAtNewTemp(newT, growth_import$lag[allele_index])
  newMu <-  muAtNewTemp(newT, growth_import$mu[allele_index])
  
  data$count[i] <- log10N(data$day[i]*24, newLag, newMu*0.8,data$logMPN_init[i],growth_import$Nmax[allele_index],growth_import$modelname[allele_index])
}
  
```
