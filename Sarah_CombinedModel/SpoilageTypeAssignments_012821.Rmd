---
title: "SpoilageTypeAssignments"
author: "Sarah I. Murphy"
date: "1/28/2021"
output: html_document
---
Created 1/28/2021, Sarah Murphy. Original file was named "DataPrep_022720.R", written by Sarah Murphy for an early version of the combined model, found in "MC-2020/Sarah_CombinedModel/Archive". Sarah created a new Rmarkdown file named "SpoilageTypeAssigments" and transferred code from the original R file to the Rmarkdown file. Basically, take the VSL file and then 

Revised X/XX/2021, Sarah Murphy. Added this text temporarily until first revisions are made.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Set-up environment
* load packages
* load data files
* prep data
```{r}
## load packages
library(readxl)
library(readr)
library(tidyverse)
```

```{r}
## load data files
freq_df <-  read_csv("SpoilageTypeAssignments/Frequency_ALLISOLATES_021120.csv") #freq file; isolates from Sam R's study
df <- read_csv("SpoilageTypeAssignments/Samantha Sample micro data 2020-02-25.csv") #count data for samples from Sam R's study
```

```{r}
## prep data

# rename columns in df
colnames(df)[1] <- "VSLNumber"
# only use pasteurized fluid white milk; either 1, 2, 3, or 4 from the right (after removing "-" to the left)
df$SampleID<- trimws(df$SampleID, which = c("both"))
df$temp <- df$SampleID
df <- df %>%
  separate(temp,c("id1","id2"),sep="-")
df <- df %>%
  separate(id1,c("id3","milkType"),sep=-1)
dfw <- df %>%
  filter(milkType == "1"|milkType == "2"|milkType == "3"|milkType == "4")%>% #only include white milk
  filter(id3 !="1N 4"&id3 !="1N 3"&id3 !="1N 2"&id3 !="1N 1"&id3 !="2N 1"&id3 !="3NPOST 1"&id3 !="3NPRE 1" )%>%
  filter(SampleID!=	"72-1*" & SampleID!=	"73-1*")

# prep dfw
dfw$VSLNumber_SampleID <- paste(dfw$VSLNumber,dfw$SampleID,sep="_")
dfw$Test_Day <- paste(dfw$Test,dfw$Day,sep="_")
dfw$Plant_VSLNumber_SampleID <- paste(dfw$Plant,dfw$VSLNumber_SampleID,sep="_")
dfw$Countability[is.na(dfw$Countability)==TRUE] <- "OK"
dfw <- dfw %>%
  filter(Countability!="M")
# convert dates to appropriate format
dfw$`Date Collected` <- as.Date(dfw$`Date Collected`,'%m/%d/%Y')
dfw$`Date Processed`<- as.Date(dfw$`Date Processed`,'%m/%d/%Y')
dfw$Day_Initial_Actual<- difftime(dfw$`Date Collected`,dfw$`Date Processed`, units = "days") # days

#temp
# dfw$log10count<- log10(as.numeric(dfw$`Count Value`))
colnames(dfw)[9]<-"greaterThanLessThan"
# dfw2 <- dfw[c(16,19,17)] %>%
#   spread(.,Test_Day,log10count)"
dfw2 <- dfw[c(16,10,17)] %>%
  spread(.,Test_Day,`Count Value`)
dfw2[is.na(dfw2)==TRUE] <- "NotTested"

dfw$LODtemp <- "LOD"
dfw$LOD_Test_Day <- paste(dfw$LODtemp,dfw$Test_Day,sep="_")
dfw2b <- dfw[c(17,9,20)] %>%
  spread(.,LOD_Test_Day,greaterThanLessThan)
dfw2b[is.na(dfw2b)==TRUE] <- "OK"
dfw2_merged <- merge(dfw2,dfw2b,by="Plant_VSLNumber_SampleID")
temp <- unique(dfw[c(17,18)])
dfw2_merged2 <- merge(dfw2_merged,temp,by="Plant_VSLNumber_SampleID")
dfw2_merged2<- separate(data=dfw2_merged2, Plant_VSLNumber_SampleID,c("Plant", "VSLNumber", "SampleID"),sep="_")
dfw2_merged2 <- dfw2_merged2[c(1:3,28,4:27)]
# write.csv(dfw2_merged2,"dfw2_merged_022720.csv")
```

```{r}
# read in Sam R's PPC data
df_PPC_raw <- read_excel("SpoilageTypeAssignments/Sarah S-PPC query 2020-02-27_withPlant.xlsx")
# rename columns in df_PPC
df_PPC <- df_PPC_raw  
colnames(df_PPC)[2] <- "VSLNumber"
# only use pasteurized fluid white milk; either 1, 2, 3, or 4 from the right (after removing "-" to the left)
df_PPC$SampleID<- trimws(df_PPC$SampleID, which = c("both"))
df_PPC$temp <- df_PPC$SampleID
df_PPC <- df_PPC %>%
  separate(temp,c("id1","id2"),sep="-")
df_PPC <- df_PPC %>%
  separate(id1,c("id3","milkType"),sep=-1)
df_PPCw <- df_PPC %>%
  filter(milkType == "1"|milkType == "2"|milkType == "3"|milkType == "4") %>% #only include white milk
  filter(id3 !="1N 4"&id3 !="1N 3"&id3 !="1N 2"&id3 !="1N 1"&id3 !="2N 1"&id3 !="3NPOST 1"&id3 !="3NPRE 1" )%>%
  filter(SampleID!=	"72-1*" & SampleID!=	"73-1*")
temp2 <- df_PPCw[c(1:6)]

# merge Sam R PPC with dfw2merged2
SamRdat_full <- merge(dfw2_merged2,temp2,by=c("Plant","VSLNumber","SampleID"), all.x=TRUE)
# write.csv(SamRdat_full,"SamRdat_full.csv")
SamRdat_full$`S-PPC` <- as.character(SamRdat_full$`S-PPC`)
#clear environment
# rm(list=setdiff(ls(), c("SamRdat_full","freq_df1")))
test <- unique(freq_df[c(1,5)]) # unique ST

df_freq <- read_excel("SpoilageTypeAssignments/Samantha Sarah Frequency Table 2020-02-26.xlsx")
df_freq2 <- df_freq %>%
  filter(Day == "D21"|Day == "D17"|Day == "D14") %>% # change this to 17 so taht we can have more ST
  filter(`Gram Status`== "-")
df_freq2$temp <- df_freq2$SampleID
df_freq2 <- df_freq2 %>%
  separate(temp,c("id1","id2"),sep="-")
df_freq2 <- df_freq2 %>%
  separate(id1,c("id3","milkType"),sep=-1)
df_freq2 <- df_freq2 %>%
  filter(milkType!="*")
df_freq2w <- df_freq2 %>%
  filter(milkType == "1"|milkType == "2"|milkType == "3"|milkType == "4") %>% #only include white milk
  filter(id3 !="1N 4"&id3 !="1N 3"&id3 !="1N 2"&id3 !="1N 1"&id3 !="2N 1"&id3 !="3NPOST 1"&id3 !="3NPRE 1" )%>%
  filter(SampleID!=	"72-1*" & SampleID!=	"73-1*")
# df_freq2wM <- df_freq2w %>%
#   filter(is.na(`16S ST`)==TRUE)
# write.csv(df_freq2wM,"df_missingST.csv")
df_freq2w2 <- unique(df_freq2w[c(4,9,10,16)])
df_freq2w3 <- df_freq2w2 %>%
  filter(is.na(`16S ST`)!=TRUE)
colnames(df_freq2w3)[1] <- "Plant"

#
# write.csv(df_freq2w3,"df_freq_D21only_unique16SST.csv")
```

```{r}
# import Sam L's initial count stuff
micro_PPC <- read_csv("SpoilageTypeAssignments/Redo of initial concentration/Initialmicrodata_final_SL_022720.csv")
micro_PPC <- micro_PPC %>%
  separate(ID,c("VSLNumber","SampleID"),sep="_")
micro_PPC$Lau_SpoiledPPC_yn  <- "yes"
micro_PPC_freq <- micro_PPC[c(2:4,9)]
test <- merge(micro_PPC_freq,SamRdat_full,by=c("Plant","VSLNumber","SampleID"),all = TRUE)

test$Lau_SpoiledPPC_yn[is.na(test$Lau_SpoiledPPC_yn)==TRUE]<- "no"

test$SPC_DI<- as.numeric(test$SPC_DI)
test$SPC_D7<- as.numeric(test$SPC_D7)
test$SPC_D10<- as.numeric(test$SPC_D10)
test$SPC_D14<- as.numeric(test$SPC_D14)
test$SPC_D17<- as.numeric(test$SPC_D17)
test$SPC_D21<- as.numeric(test$SPC_D21)

test$CVTA_DI<- as.numeric(test$CVTA_DI)
test$CVTA_D7<- as.numeric(test$CVTA_D7)
test$CVTA_D10<- as.numeric(test$CVTA_D10)
test$CVTA_D14<- as.numeric(test$CVTA_D14)
test$CVTA_D17<- as.numeric(test$CVTA_D17)
test$CVTA_D21<- as.numeric(test$CVTA_D21)

test$Spoiled20000_yn <- ifelse((test$SPC_DI>20000 | test$SPC_D7>20000 | test$SPC_D10>20000| test$SPC_D14>20000| test$SPC_D17>20000| test$SPC_D21>20000), "yes", "NotSpoiled") #same as "S" column, but for all
# test$Spoiled1mill_yn <- ifelse((test$SPC_DI>1000000 | test$SPC_D7>1000000 | test$SPC_D10>1000000| test$SPC_D14>1000000| test$SPC_D17>1000000| test$SPC_D21>1000000), "yes", "no") #same as "S" column, but for all
test$AnyGN_yn <- ifelse((test$CVTA_DI>1000 | test$CVTA_D7>1000 | test$CVTA_D10>1000| test$CVTA_D14>1000| test$CVTA_D17>1000| test$CVTA_D21>1000), "yes", "no") #same as "S" column, but for all
test$exceed20000byD10_yn <- ifelse((test$SPC_DI>20000 | test$SPC_D7>20000 | test$SPC_D10>20000), "yes", "no") #same as "S" column, but for all
test$exceed100000postD10_yn <- ifelse(test$exceed20000byD10_yn == "no" & (test$SPC_D14>100000 | test$SPC_D17>100000 | test$SPC_D21>100000), "yes", "no") #same as "S" column, but for all

test$temp1 <- ifelse(test$CVTA_DI>1000,1,0)
test$temp2 <-ifelse(test$CVTA_D7>1000,1,0)
test$temp3 <-ifelse(test$CVTA_D10>1000,1,0)
test$temp4 <-ifelse(test$CVTA_D14>1000,1,0)
test$temp5 <-ifelse(test$CVTA_D17>1000,1,0)
test$temp6 <-ifelse(test$CVTA_D21>1000,1,0)
test$tempadd <- test$temp1 + test$temp2 + test$temp3 + test$temp4 + test$temp5 + test$temp6
test$GN_AtLeast2x <- ifelse(test$tempadd>1,"yes","no")

test$spoilagetype2 <- paste(test$Spoiled20000_yn,test$exceed20000byD10_yn,test$AnyGN_yn,sep="_")
test$spoilagetype[test$spoilagetype2=="yes_yes_yes"]<-"ppc"
test$spoilagetype[test$Spoiled20000_yn=="NotSpoiled"]<-"NotSpoiled"
test$spoilagetype[test$spoilagetype2=="yes_no_no"]<-"spore"
test$spoilagetype[test$spoilagetype2=="yes_no_yes"]<-"REVIEW"
test$spoilagetype[test$GN_AtLeast2x=="no" &test$spoilagetype=="REVIEW"]<-"spore"
test$spoilagetype[test$exceed100000postD10_yn=="yes" &test$spoilagetype=="REVIEW"]<-"spore"


reviewdf <- test %>%
  filter(spoilagetype=="REVIEW")
reviewdf <- reviewdf[c(1:5,11,10,6:9,17,16,12:15,18:37)]

#whatever remains, remove from the dataset
micro_test <- test %>%
  filter(spoilagetype!="REVIEW")
micro_PPC$Log10CFU_Initial <- micro_PPC$Slope + micro_PPC$Y_intercept
micro_final<- merge(micro_test,micro_PPC,by=c("Plant","VSLNumber","SampleID"),all=TRUE)

micro_full <- micro_final[c(1:3,5,46,53,12:17,24:29)]
micro_full$Log10CFU_Initial[micro_full$spoilagetype=="spore"]<-"NA"
micro_full$Log10CFU_Initial[is.na(micro_full$Log10CFU_Initial)==TRUE]<-"NA"
micro_full$Log10CFU_Initial <- as.numeric(micro_full$Log10CFU_Initial)
micro_full$Log10CFU_Initial_1logRed <- micro_full$Log10CFU_Initial - 1
micro_full$Log10CFU_Initial_2logRed <- micro_full$Log10CFU_Initial - 2
micro_full$CFU_Initial  <- 10^micro_full$Log10CFU_Initial 
micro_full$CFU_Initial_1logRed  <- 10^micro_full$Log10CFU_Initial_1logRed 
micro_full$CFU_Initial_2logRed  <- 10^micro_full$Log10CFU_Initial_2logRed 

# 

#clear environment
rm(list=setdiff(ls(), c("df_freq2w3","micro_full")))

colnames(df_freq2w3)[2] <- "VSLNumber"
micro_ppc <- micro_full %>%
  filter(spoilagetype == "ppc")

micro_ppc_samples <- micro_ppc[c(1:3)]
freq_16S_ppc <- merge(df_freq2w3,micro_ppc_samples,by=c("Plant","VSLNumber","SampleID"),all.y = TRUE)
freq_spoilagetype <- micro_full[c(1:3,5,7:18)]
rm(list=setdiff(ls(), c("freq_16S_ppc","micro_ppc","freq_spoilagetype")))

# write.csv(freq_16S_ppc,"freq_16S_ppc.csv")
# write.csv(micro_ppc,"micro_ppc.csv")
# write.csv(freq_spoilagetype,"freq_spoilagetype.csv")
# 
# temp <- micro_PPC[c(2:6,9:14)]
# colnames(micro_PPC)[2] <- 
# merge(micro)
## get data for Upstate Buffalo
# UB_16Sfreq <- df_freq2w3 %>%
#   filter(Plant == "Upstate Buffalo")
# UB_micro_all <- SamRdat_full %>%
#   filter(Plant == "Upstate Buffalo")
# UB_micro_S_PPC <- UB_micro_all %>%
#   filter(`S-PPC` == "TRUE")
# UB_micro_S_PPC <- UB_micro_S_PPC[c(1:4,10,9,5:8,16,15,11:14,17:31)]
# UB_micro_all <- UB_micro_all[c(1:4,31,10,9,5:8,16,15,11:14,17:30)]

# 

```

