---
title: "MCsim_ForoughFFARModel_Simple"
author: "Sarah I. Murphy, Samantha Lau, Timothy Lott, Aljosa Trmcic"
date: "2/16/2020"
output: pdf_document
---

This is a simplified version (deleted unnecessary stuff) of MCsim_ForoughFFARModel. 

The authors listed above are current contributors to this file. Earlier versions were the work of Ariel Buehler and Michael Phillips. Review README.md [https://github.com/FSL-MQIP/MC-2020/blob/master/README.md] for more information.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Set-up environment
* load packages
* load functions
* set seed for reproducibilty
```{r}
## load packages
library(readr)
library(dplyr)

## load functions
source("UtilityFunctions.R")

## set seed
set.seed(1)
```

## 2. Load input files
* load
```{r}
# (a) AT/ST frequency data
# spore
spore_ATfrequency_file <- "Ariel_2017MC_SporeModel/InputFiles/ColdgrowATFreq_CrossSect.csv"
spore_ATfreq_import <- read.csv(spore_ATfrequency_file, stringsAsFactors = FALSE, header = TRUE)

# (b) growth parameter data; make sure this contains growth parameters & growth model name
# spore 
spore_growth_file <- "Ariel_2017MC_SporeModel/InputFiles/GrowthParameters.csv" 
spore_growth_import <-read.csv(spore_growth_file, stringsAsFactors = FALSE)
```

* Check input files for spore & ppc have the same structure and then modify here as necessary to match
```{r}
spore_ATfreq_import$temp <- "AT"
spore_ATfreq_import$ClosestAT <- paste(spore_ATfreq_import$temp,spore_ATfreq_import$ClosestAT,sep="_")

spore_growth_import <- spore_growth_import %>%
  .[c(1:5)]%>%
  rename(STorAT = rpoBAT)
spore_growth_import$model_name <- "buchanan" #may change later
spore_growth_import$temp <- "AT"
spore_growth_import$STorAT <- paste(spore_growth_import$temp,spore_growth_import$STorAT,sep="_")
```

## 3. Set-up dataframe

i. Set important parameters for running the simulation:
```{r}
# (a) n_sim
# Definition: Number of simulations to run (also referred to as the number of bulk tanks in earlier code; i.e., 1 simulation unit = 1 lot of milk)
n_sim <- 10000 #can use any n_sim for testing code, but need to change to at least 10k when running experiments

# (b) n_units 
# Definition: Number of units per lot (currently, half gallon units) 
n_units <- 10

# (c) start_day 
# Definition: First time point (in days) in unit's shelf life to simulate
start_day <- 1 

# (d) end_day 
# Definition: Last time point (in days) in unit's shelf life to simulate
end_day <- 35 
n_day <- 35 # seems like this is the end_day, but keeping code below for now in case my interpretation is wrong
```

ii. Prep vectors using defined values above
```{r}
# (a) lot_id
#Make a vector for "lot_id" by repeating sequence of 1:n_sim for length of n_units * n_day
lot_id <- rep(seq(1, n_sim), each = n_units * n_day)

# (b) milk_unit
#Make a vector for "milk_unit" by repeating the sequence of 1:n_units by n_day * n_sim
milk_unit <- rep(seq(1, n_units), times = n_day * n_sim) 

# (c) STorAT
# Make an empty vector for "STorAT" with the length of n_sim * n_units * n_day
STorAT <- vector(mode="logical", n_sim * n_units * n_day) 

# (d) day
#Make a vector repeating days in shelf life that are simulated for each simulation run (i.e., each bulk tank) 
day <- rep(rep(seq(start_day, start_day+n_day-1), each = n_units), times = n_sim) 

# (e) count
#Make an empty vector for "count" with the length of n_sim * n_units * n_day
count <- vector(mode = "logical", n_sim * n_units * n_day) 

# (f) spoilage_type
#Make an empty vector for "spoilage_type" with the length of n_sim * n_units * n_day
spoilage_type <- vector(mode = "logical", n_sim * n_units * n_day) 
```

iii. Prep dataframe using vectors above (each vector becomes a column)
```{r}
data <- data.frame(lot_id, milk_unit, STorAT, spoilage_type, day, count)
```

## 4. Prepare distributions using input data
a. Frequency of allelic types
```{r}
## (a) Frequency of allelic types
#Here, the "distribution" of ATs are taken directly from the input file by creating a vector of the AT in each of the rows in the the column containing the AT
AT_freq <- spore_ATfreq_import$ClosestAT 

```

## 5. Sample distributions

i. Sample distributions
    a. Sample AT from AT_freq
```{r}
AT <- vector()
for (i in 1:n_sim){
 AT_samp <- rep(sample(AT_freq, n_units, replace = T), times = n_day)
  AT <- c(AT, AT_samp)}
```

iii. Add results from sampling distribution in (i) to dataframe
```{r}
data$STorAT <- AT
```

iv. Use given value for spore_MPN_init
*Run it 10,000 times for each -1.989, -1.239, -0.720, -0.201, 0.549 (i.e, 1.290, 2.040, 2.559, 3.078, 3827 in log CFU/HG), and whenever 500 packages exceed 1M/mL, that's the shelf-life. So I need 5 shelf-lives.

```{r}
#Add spore_log10CFU_init to dataframe
data$logCount_init  <- -1.989 #change for each of 5 rounds here & in next chunk
```

## 6. Calculate log10N for each row in dataframe
* Run simple version 
```{r}
for (i in 1:(n_sim *n_units * n_day)){
  allele_index <- which(spore_growth_import$STorAT == data$STorAT[i]) 
  data$count[i] <- log10N_func(data$day[i],spore_growth_import$lag[allele_index],spore_growth_import$mumax[allele_index],-1.989,spore_growth_import$LOG10Nmax[allele_index])}
```

## 7. Save results
    1. MCsim_result_df_F1 is for logCount_init = -1.989
    2. MCsim_result_df_F2 is for logCount_init = -1.239
    3. MCsim_result_df_F3 is for logCount_init = -0.720
    4. MCsim_result_df_F4 is for logCount_init = -0.201
    5. MCsim_result_df_F5 is for logCount_init = 0.549
```{r}
save(data,file="MCsim_result_df_F1.RData")
# save(data,file="MCsim_result_df_F2.RData")
# save(data,file="MCsim_result_df_F3.RData")
# save(data,file="MCsim_result_df_F4.RData")
# save(data,file="MCsim_result_df_F5.RData")

```




