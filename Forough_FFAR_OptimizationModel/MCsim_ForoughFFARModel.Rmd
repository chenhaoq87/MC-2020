---
title: "MCsim_ForoughFFARModel"
author: "Sarah I. Murphy, Samantha Lau, Timothy Lott, Aljosa Trmcic"
date: "2/14/2020"
output: pdf_document
---

The authors listed above are current contributors to this file. Earlier versions were the work of Ariel Buehler and Michael Phillips. Review README.md [https://github.com/FSL-MQIP/MC-2020/blob/master/README.md] for more information.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Set-up environment
* load packages
* load functions
* set seed for reproducibilty
```{r}
## load packages
library(readr)
# library(censReg)
# library(fitdistrplus)
# library(splitstackshape)
library(dplyr)

## load functions
source("UtilityFunctions.R")

## set seed
set.seed(1)
```

## 2. Load input files
* load
```{r}
# (a) AT/ST frequency data
# spore
spore_ATfrequency_file <- "Ariel_2017MC_SporeModel/InputFiles/ColdgrowATFreq_CrossSect.csv"
spore_ATfreq_import <- read.csv(spore_ATfrequency_file, stringsAsFactors = FALSE, header = TRUE)

# ppc
# ppc_STfrequency_file <- "Sam_FFAR_PPCmodel/InputFiles/Frequency_ONLYSAMISOLATES_remove13and23_020120.csv"
# ppc_STfreq_import <- read.csv(ppc_STfrequency_file, stringsAsFactors = FALSE, header = TRUE)

# (b) growth parameter data; make sure this contains growth parameters & growth model name
# spore 
spore_growth_file <- "Ariel_2017MC_SporeModel/InputFiles/GrowthParameters.csv" 
spore_growth_import <-read.csv(spore_growth_file, stringsAsFactors = FALSE)

# ppc
# ppc_growth_file <- "Sam_FFAR_PPCmodel/InputFiles/GrowthParameters_remove13and23_020120.csv" 
# ppc_growth_import <-read.csv(ppc_growth_file, stringsAsFactors = FALSE)

# (c) initial count logMPN data
# init_file <- "InitialCountsMPN.csv"
# initialcount_import <- read.csv(init_file, stringsAsFactors = FALSE)

# spore
# spore_init_file <- read.csv("Ariel_2017MC_SporeModel/InputFiles/CrossSectional_RawMPN_3.6.17.csv")

# # ppc
# ppc_init_file <- read_csv("Sam_FFAR_PPCmodel/InputFiles/Initialmicrodata_MCinput_SL_021420.csv")

# (d) temperature data for each stage (Note for Sarah to fix temp_stages format)
# temp_stages_file <- "temp_stages.csv"
# temp_by_stage <- read.csv(temp_stages_file, stringsAsFactors = F, comment.char = "#")

# (e) PPC frequency data
# source("FreqPPC.R")
```

* Check input files for spore & ppc have the same structure and then modify here as necessary to match
```{r}
# modify frequency data file structure for ppc to match spore and also added "ST_" and "AT_", respectively to aid analysis
# ppc_STfreq_import <- ppc_STfreq_import %>% 
#   rename(RealAT = X16S_ST)
# ppc_STfreq_import$ClosestST <- ppc_STfreq_import$RealAT
# ppc_STfreq_import <- ppc_STfreq_import[c(5:6)]
# ppc_STfreq_import$temp <- "ST"
# ppc_STfreq_import$ClosestST <- paste(ppc_STfreq_import$temp,ppc_STfreq_import$ClosestST,sep="_")

spore_ATfreq_import$temp <- "AT"
spore_ATfreq_import$ClosestAT <- paste(spore_ATfreq_import$temp,spore_ATfreq_import$ClosestAT,sep="_")

# modify growth import data file structure and also added "ST_" and "AT_", respectively to aid analysis
# ppc_growth_import <- ppc_growth_import %>% 
#   rename(STorAT = ST,
#          mumax = mu,
#          LOG10N0 = N0,
#          LOG10Nmax = Nmax,
#          model_name = modelname)  
# ppc_growth_import$temp <- "ST"
# ppc_growth_import$STorAT <- paste(ppc_growth_import$temp,ppc_growth_import$STorAT,sep="_")

spore_growth_import <- spore_growth_import %>%
  .[c(1:5)]%>%
  rename(STorAT = rpoBAT)
spore_growth_import$model_name <- "buchanan" #may change later
spore_growth_import$temp <- "AT"
spore_growth_import$STorAT <- paste(spore_growth_import$temp,spore_growth_import$STorAT,sep="_")

# ppc_init_file <- ppc_init_file %>%
#   .[c(1,3)]%>%
#   rename(CFU = `Initial conc`)
# ppc_init_file$log10CFU <- log10(ppc_init_file$CFU)
```

## 3. Set-up dataframe

i. Set important parameters for running the simulation:
```{r}
# (a) n_sim
# Definition: Number of simulations to run (also referred to as the number of bulk tanks in earlier code; i.e., 1 simulation unit = 1 lot of milk)
n_sim <-100 #can use any n_sim for testing code, but need to change to at least 10k when running experiments

# (b) n_units 
# Definition: Number of units per lot (currently, half gallon units) 
n_units <- 10

# (c) start_day 
# Definition: First time point (in days) in unit's shelf life to simulate
start_day <- 1 

# (d) end_day 
# Definition: Last time point (in days) in unit's shelf life to simulate
end_day <- 35 
n_day <- 35 # seems like this is the end_day, but keeping code below for now in case my interpretation is wrong
```

ii. Prep vectors using defined values above
```{r}
# (a) lot_id
#Make a vector for "lot_id" by repeating sequence of 1:n_sim for length of n_units * n_day
lot_id <- rep(seq(1, n_sim), each = n_units * n_day)

# (b) milk_unit
#Make a vector for "milk_unit" by repeating the sequence of 1:n_units by n_day * n_sim
milk_unit <- rep(seq(1, n_units), times = n_day * n_sim) 

# (c) STorAT
# Make an empty vector for "STorAT" with the length of n_sim * n_units * n_day
STorAT <- vector(mode="logical", n_sim * n_units * n_day) 

# (d) day
#Make a vector repeating days in shelf life that are simulated for each simulation run (i.e., each bulk tank) 
day <- rep(rep(seq(start_day, start_day+n_day-1), each = n_units), times = n_sim) 

# (e) count
#Make an empty vector for "count" with the length of n_sim * n_units * n_day
count <- vector(mode = "logical", n_sim * n_units * n_day) 

# (f) spoilage_type
#Make an empty vector for "spoilage_type" with the length of n_sim * n_units * n_day
spoilage_type <- vector(mode = "logical", n_sim * n_units * n_day) 
```

iii. Prep dataframe using vectors above (each vector becomes a column)
```{r}
data <- data.frame(lot_id, milk_unit, STorAT, spoilage_type, day, count)
```

## 4. Prepare distributions using input data
a. Initial contamination: logMPN normal distribution
b. Frequency of allelic types
c. Temperature distribution for each stage 
d. Frequency of PPC (i.e., spoilage_type)
```{r}
## (a) Initial contamination: logMPN normal distribution (note: How is the initialcount_import data used? Where did logMPN_mean and logMPN_sd come from?)

# determine appropriate normal distribution based on input data 
# (i) spore data
# spore_init_file$log10left <- log10(spore_init_file$left)
# spore_init_file$log10right <- log10(spore_init_file$right)
# spore_init_file$log10MPN <- log10(spore_init_file$MPN)
# cens_data <- spore_init_file[,c("log10left","log10right")]
# names(cens_data) <- c("left","right")
# spore_fit <- fitdistcens(censdata = cens_data,distr = "norm")
# hist(spore_init_file$log10MPN,freq=F,xlim = c(-4,4))
# curve(dnorm(x,mean=spore_fit$estimate[1],sd = spore_fit$estimate[2]),add=T)
# plot(spore_fit)
# summary(spore_fit)
# 
# spore_log10MPN_mean <- spore_fit$estimate[1]
# spore_log10MPN_sd <- spore_fit$estimate[2]

# (ii) ppc data; https://stats.stackexchange.com/questions/132652/how-to-determine-which-distribution-fits-my-data-best
# ppc_fit <- fitdist(data = ppc_init_file$log10CFU,distr = "norm")
# plot(ppc_fit) #fit looks OK
# 
# ppc_log10CFU_mean <- ppc_fit$estimate[1]
# ppc_log10CFU_sd <- ppc_fit$estimate[2]

## (b) Frequency of allelic types
#Here, the "distribution" of STs or ATs are taken directly from the input file by creating a vector of the ST or AT in each of the rows in the the column containing the ST or AT
# (i) spore data
AT_freq <- spore_ATfreq_import$ClosestAT 
# (ii) ppc data
# ST_freq <- ppc_STfreq_import$ClosestST 

## (c) Temperature distribution for each stage (Note for Sarah to fix)
#Here, the distribution and parameters are currently already written into the input file
# temp_by_stage

## (d) Frequency of PPC
# PPC_freq <- as.character(df_freqPPC$exceed20000_d10) #can change this to change by samplings or plants (or can rewrite code below)
```

## 5. Sample distributions

i. Sample distributions
    a. Sample MPN_init from the initial MPN
    b. Sample whether PPC from PPC_freq
    c. Sample AT from AT_freq
    d. Sample temp from temp_by_stage
```{r}
## (a) Sample init_count from both the spore & ppc data
# (i) spore
# #Sample the spore_log10MPN distribution 
# spore_log10MPN_samp <- rnorm(n_sim, spore_log10MPN_mean, spore_log10MPN_sd)
# 
# #Convert spore_log10MPN_samp back to spore_MPN_samp
# spore_MPN_samp <- 10^spore_log10MPN_samp
# 
# #Convert MPN for each sample (here, unique for each simulation aka lot) to equivalent in milk unit of interest (here, unit = half gallon; 1892.71 mL in half gallon)
# spore_MPN_samp_halfgal <- spore_MPN_samp * 1900
# 
# #Sample the MPN_init distribution
# spore_MPN_init<-vector()
# for (i in 1:n_sim){
#   spore_MPN_init_samp <-rep(rpois(n_units, spore_MPN_samp_halfgal[i]), times = n_day)
#   spore_MPN_init<-c(spore_MPN_init, spore_MPN_init_samp)}

# (ii) ppc
# #Sample the ppc_log10CFU distribution 
# ppc_log10CFU_samp <- rnorm(n_sim, ppc_log10CFU_mean, ppc_log10CFU_sd) 
# 
# #Convert ppc_log10MPN_samp back to spore_MPN_samp
# ppc_CFU_samp <- 10^ppc_log10CFU_samp
# 
# #Convert CFU for each sample (here, unique for each simulation aka lot) to equivalent in milk unit of interest (here, unit = half gallon; 1892.71 mL in half gallon)
# ppc_CFU_samp_halfgal <- ppc_CFU_samp * 1900
# 
# #Sample the CFU_init distribution
# ppc_CFU_init<-vector()
# for (i in 1:n_sim){
#   ppc_CFU_init_samp <-rep(rpois(n_units, ppc_CFU_samp_halfgal[i]), times = n_day)
#   ppc_CFU_init<-c(ppc_CFU_init, ppc_CFU_init_samp)}


## (b) Sample the PPC_freq distribution
# spoilage_ppc <- vector()
# for (i in 1:n_sim){
#   spoilage_ppc_samp <- rep(sample(PPC_freq, n_units, replace = T), times = n_day)
#   spoilage_ppc <- c(spoilage_ppc, spoilage_ppc_samp)}

## (c) Sample from ATorST from AT_freq and ST_freq distributions, respectively
# (i) sample AT_freq 
AT <- vector()
for (i in 1:n_sim){
 AT_samp <- rep(sample(AT_freq, n_units, replace = T), times = n_day)
  AT <- c(AT, AT_samp)}

# (ii) sample ST_freq
# ST <- vector()
# for (i in 1:n_sim){
#  ST_samp <- rep(sample(ST_freq, n_units, replace = T), times = n_day)
#   ST <- c(ST, ST_samp)}

## (d) Sample the temperature distribution
# temps <- vector()
# for (i in 1:n_sim){
#   for (j in 1:nrow(temp_by_stage)){
#     stage_row <- temp_by_stage[j, ]
#     n_times <- stage_row$endTime - stage_row$beginTime + 1
#     params <- as.numeric(unlist(strsplit(stage_row$parameters, " ")))
#     temp_mean <- params[[1]]
#     temp_sd <- params[[2]]
#     temp_sample <- rep(rnorm(n_units, temp_mean, temp_sd), times = n_times)
#     temps <- c(temps, temp_sample)}}
```

ib. Use given value for spore_MPN_init instead
*Run it 10,000 times for each -1.989, -1.239, -0.720, -0.201, 0.549 (i.e, 1.290, 2.040, 2.559, 3.078, 3827 in log CFU/HG), and whenever 500 packages exceed 1M/mL, that's the shelf-life. So I need 5 shelf-lives. 
```{r}
#Add spore_log10CFU_init to dataframe
data$logCount_init  <- -1.989
```

ii. Add results from sampling distribution in (i) to dataframe
```{r}
## (a) add spoilage_ppc to dataframe
# spoilage_ppc<-as.factor(spoilage_ppc)
# levels(spoilage_ppc)[levels(spoilage_ppc)=="0"] <- "spore"
# levels(spoilage_ppc)[levels(spoilage_ppc)=="1"] <- "ppc"
# data$spoilage_type <- spoilage_ppc
# data$spoilage_type <- "spore" #set to "spore" since spore only

## (a) Reformat and add initial log10CFU & log10MPN to dataframe
# (i) spore
#First convert spore_MPN_init from half-gallon to mLs
# spore_MPN_init_mL <- spore_MPN_init / 1900
# #Also need to remove 0's from the data and replace with detection limit
# spore_MPN_init_mL[spore_MPN_init_mL == 0] <- 0.01;
# #Add spore_log10CFU_init to dataframe
# data$spore_log10MPN_init <- log10(spore_MPN_init_mL) 
# 
# #(ii) ppc
#First convert ppc_CFU_init from half-gallon to mLs
# ppc_CFU_init_mL <- ppc_CFU_init / 1900
# #Also need to remove 0's from the data and replace with detection limit (check if 0.01 is actually detection limit)
# ppc_CFU_init_mL[ppc_CFU_init_mL == 0] <- 0.01;
# #Add ppc_log10CFU_init to dataframe
# data$ppc_log10CFU_init <- log10(ppc_CFU_init_mL) 

#(iii) logCount_init
# data$logCount_init <- data$spoilage_type
# data$logCount_init <- with(data, ifelse( logCount_init == "spore", spore_log10MPN_init, ppc_log10CFU_init ) )

# data$logCount_init <- data$spore_log10MPN_init #since spore only

## (b) Add AT to dataframe column STorAT
#(i) spore
# data$AT <- AT
#(ii) ppc
# data$ST <- ST
# (iii) STorAT
# data$STorAT <- data$spoilage_type
# data$STorAT <- with(data, ifelse( STorAT == "spore", AT, ST) )

#(i) spore
data$STorAT <- AT

## (c) #Add temp to dataframe
# data$temp <- temps 
# OR just set what the temperature should be for all:
# data$temp <- 6

```

iii. Prepare empty vectors for newTemp, newMu, newLag with length n_sim * n_units * n_day
```{r}
# data$newTemp <- vector(mode="logical", n_sim * n_units * n_day)
# data$newMu <- vector(mode="logical", n_sim * n_units * n_day)
# data$newLag <- vector(mode="logical", n_sim * n_units * n_day)
```

iv. join growth_import files
```{r}
# growth_import<-rbind(ppc_growth_import,spore_growth_import)
```

## 6. Calculate log10N for each row in dataframe
```{r}
##Get the ST or AT and day from the data frame, get growth parameters depending on the ST or AT
# Simulation   ----
# for (i in 1:(n_sim *n_units * n_day)){
#   #Find row in growth parameter data that corresponds to allele sample
#   allele_index <- which(growth_import$STorAT == data$STorAT[i]) 
#   row <- data[i, ]
#   prev_row <- getPrevRow(data, row$lot_id, row$milk_unit, row$day)
#   update <- ifelse(nrow(prev_row) == 0 || row$temp != prev_row$temp, T, F)
#   #calculate the new growth parameters using the square root model and our
#   #sampled temperature
#   
#     newT <- row$temp
#     newLag <- ifelse(update, 
#                      lagAtNewTemp(row$day, newT, growth_import$lag[allele_index]),
#                      prev_row$newLag)
#      old_lag <- ifelse(row$day==1, newLag, prev_row$newLag )
#      # newLag <- ifelse(update & row$day <= old_lag & row$day > 1, 
#      #                  adjustLag(row$day, old_lag, newLag),
#      #                  old_lag)
#      newLag <- ifelse(update & row$day > 1, 
#                       adjustLag(row$day, old_lag, newLag, restartExp = F),
#                       old_lag)
#     newMu <-  ifelse(update, 
#                      muAtNewTemp(newT, growth_import$mumax[allele_index]),
#                      prev_row$newMu)
#   data$newTemp[i] <- newT
#   data$newLag[i] <- newLag
#   data$newMu[i] <- newMu
#   
#   #Calculate the log10N count using our new growth parameters
#   newCount <- log10N_func(row$day, newLag, newMu,data$logCount_init[i],growth_import$LOG10Nmax[allele_index])
#   oldCount <- log10N_func(row$day-1, newLag, newMu,data$logCount_init[i],growth_import$LOG10Nmax[allele_index])
#   data$count[i] <- ifelse(row$day==1, newCount,
#                           prev_row$count + (newCount-oldCount))
# }
```

* Run simple version (not including stages)
    *put count for spore and ppc in different columns for now since data had been hour previously for ppc
```{r}
for (i in 1:(n_sim *n_units * n_day)){
  allele_index <- which(spore_growth_import$STorAT == data$STorAT[i]) 
  data$count[i] <- log10N_func(data$day[i],spore_growth_import$lag[allele_index],spore_growth_import$mumax[allele_index],-1.989,spore_growth_import$LOG10Nmax[allele_index])}

# for (i in 1:(n_sim *n_units * n_day)){
#   allele_index <- which(growth_import$STorAT == data$STorAT[i]) #Find row in growth parameter data that corresponds to allele sample
#   row <- data[i, ]
#   prev_row <- getPrevRow(data, row$lot_id, row$milk_unit, row$day)
#   update <- ifelse(nrow(prev_row) == 0 || row$temp != prev_row$temp, T, F)
  # data$spore_count[i] <- log10N_func(data$day[i],growth_import$lag[allele_index],growth_import$mumax[allele_index],data$logCount_init[i],growth_import$LOG10Nmax[allele_index]) 
  # data$ppc_count[i] <- log10N_func(data$day[i]*24,growth_import$lag[allele_index],growth_import$mumax[allele_index],data$logCount_init[i],growth_import$LOG10Nmax[allele_index])}
```
* Get count data
```{r}
# data$count <- data$spoilage_type
# data$count <- with(data, ifelse( count == "spore", spore_count, ppc_count ) )
```

## 7. Save results
```{r}
save(data,file="MCsim_result_df_F1.RData")
```




